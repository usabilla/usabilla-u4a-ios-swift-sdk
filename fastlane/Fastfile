fastlane_version "2.64.1"
import "./CarthageFastFile.rb"
import "./BuildFastFile.rb"

default_platform :ios
actions_path "#{File.expand_path(File.dirname(__FILE__))}/../"
platform :ios do

    # def xcode_version 
    #     sh("xcodebuild -version | head -1 | sed -e 's@.*\([0-9]..\).*@\1@'")
    # end
    def projectDirectory
        "#{File.expand_path(File.dirname(__FILE__))}/../"
    end

    def cleanReleaseProject
        sh("rm -rf #{projectDirectory}ReleaseValidator/Usabilla.Framework")        
    end

    def readXcodeVersions
        JSON.parse(File.read("versions.json"), {:symbolize_names => true})
    end

    def readXcodeVersionsValidation
        JSON.parse(File.read("versions-validate.json"), {:symbolize_names => true})
    end

    def resetSimulator
       sh("killall -9 'Simulator' || echo 'No simulator launched'")
       sh("launchctl remove com.apple.CoreSimulator.CoreSimulatorService || true")
    end

    desc "Builds the framework for the specified framework"
    lane :buildSDK do |options|
        unless options[:version]
            UI.error("missing Xcode version")
        end
        version = options[:version]
        UI.message("Building for Xcode-#{version}")
        xcversion(version: version)
        buildFramework
        buildCarthage
        crateReleaseDirectory(
            version: version,
            project_directory: projectDirectory
        )
        cleanProject
    end

    desc "Check that all required xcode versions are installed"
    lane :checkXcodeVersions do
        versions = readXcodeVersions
        versions.each do |version|
            xcversion(version: version)         
        end
        versions
    end

    desc "Builds the framework for all xcode version specified in fastlane/versions.json"
    lane :buildAll do
        versions = checkXcodeVersions
        versions.each do |version|
            buildSDK(version: version)
        end
    end

    desc "Validate integrating the framework (with specified version) into a sample project"
    lane :validateSDK do |options|
        unless options[:version]
            UI.error("missing Xcode version")
        end
        version = options[:version]
        UI.message("Validating for Xcode-#{version}")

        resetSimulator
        xcversion(version: version)
        framework_path = "#{projectDirectory}Xcode-#{version}/Pods/Usabilla.Framework"
        cleanReleaseProject
        sh("cp -r #{framework_path} #{projectDirectory}ReleaseValidator/")
	    scan(
            project: 'ReleaseValidator/ReleaseValidator.xcodeproj',
            clean: true,
            device: "iPhone SE"
        )
        cleanReleaseProject
        resetSimulator
    end

    desc "Validate integrating the framework (for all xcode version specified in fastlane/versions-validate.json) into a sample project"
    lane :validateAll do
        versions = readXcodeVersionsValidation
        versions.each do |version|
            validateSDK(version: version)
        end
    end
end
