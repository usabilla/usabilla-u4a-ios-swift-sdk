fastlane_version "2.64.1"
import "./propertiesFile.rb"
import "./CarthageFastFile.rb"
import "./BuildFastFile.rb"
import "./buildFramework.rb"
default_platform :ios
actions_path "#{File.expand_path(File.dirname(__FILE__))}/../"
platform :ios do

    desc "Builds the framework with XCode 10"
    lane :buildXcode10 do 
        buildForXcodeVersion(
            version: "10.0",
            project_directory: projectDirectory
        )
   		
    end

    desc "Create Artefacts (Pods and Carthage)"
    lane :createArteFacts do 
		copyToPodsFromBuild(
            version: "10.0",
            project_directory: projectDirectory
        )
		copyToCarthageFromBuild(
            version: "10.0",
            project_directory: projectDirectory
        )
    end

    # desc "Build for Unit Testing"
    # lane :buildForUnitTesting do
    #     xcversion(version: "10")
    #     scan(
    #         workspace: 'Usabilla.xcworkspace',
    #         scheme: 'Usabilla',
    #         clean: true,
    #         build_for_testing: true,
    #         derived_data_path: './derivedData'
    #     )
    # end

    # runUnitTests

    desc "Run unit tests for all xcode versions"
    lane :runUnitTests do
        versions = checkXcodeVersions
        versions.each do |version|
            xcversion(version: version)
            # Build for given xcode version
            scan(
                workspace: 'Usabilla.xcworkspace',
                scheme: 'Usabilla',
                clean: true,
                build_for_testing: true,
                derived_data_path: './derivedData'
            )
            # Unit test for all devices
            unitTestAllDevices(version: version)
        end
    end

    desc "Unit tests for all device model specified in fastlane/unit-tests.json"
    lane :unitTestAllDevices do |version|
        deviceModels = readUnitTestDevices
        deviceModels.each do |deviceModel|
            unitTest(deviceModel: deviceModel)
        end
    end

    desc "Unit test"
    lane :unitTest do |options|
        unless options[:deviceModel]
            UI.error("missing device model")
        end
        scan(
            workspace: 'Usabilla.xcworkspace',
            scheme: 'Usabilla',
            test_without_building: true,
            derived_data_path: './derivedData',
            code_coverage: true,
            device: options[:deviceModel]
        )
    end

    desc "Build for UI Testing"
    lane :buildForUITesting do
        scan(
            workspace: 'Usabilla.xcworkspace',
            scheme: 'UsabillaUITestApp',
            clean: true,
            build_for_testing: true,
        )
    end

    desc "UI test"
    lane :uiTest do
        scan(
            workspace: 'Usabilla.xcworkspace',
            scheme: 'UsabillaUITestApp',
            test_without_building: true,            
            devices: ["iPhone 6s (11.1)", "iPhone X (11.4)", "iPhone 7 (10.3.1)"]
        )
    end

    desc "Builds the framework for the specified framework"
    lane :buildSDK do |options|
        unless options[:version]
            UI.error("missing Xcode version")
        end
        version = options[:version]
        UI.message("Building for Xcode-#{version}")
        xcversion(version: version)
        buildFramework
        crateReleaseDirectory(
            version: version,
            project_directory: projectDirectory
        )
        cleanProject
    end

    desc "Check that all required xcode versions are installed"
    lane :checkXcodeVersions do
        versions = readXcodeVersions
        versions.each do |version|
            xcversion(version: version)         
        end
        versions
    end

    desc "Builds the framework for all xcode version specified in fastlane/versions.json"
    lane :buildAll do
        versions = checkXcodeVersions
        versions.each do |version|
        buildForXcodeVersion(
            version: version,
            project_directory: projectDirectory
        )
        #buildSDK(version: version)
        end
    end

	desc "Validate that framework does NOT have LLVM nor GCC code in the build"
	lane :validateFrameWork do
			validateBuildLLVMGCC(
            version: "10.0",
            project_directory: projectDirectory
        )
	end
	
    desc "Validate integrating the framework (with specified version) into a sample project"
    lane :validateSDK do |options|
        unless options[:version]
            UI.error("missing Xcode version")
        end
        version = options[:version]
        UI.message("Validating for Xcode-#{version}")

        resetSimulator
        xcversion(version: version)
        framework_path = "#{projectDirectory}Xcode-#{version}/Pods/Usabilla.Framework"
        cleanReleaseProject
        sh("cp -r #{framework_path} #{projectDirectory}automation/ReleaseValidator/")
	    scan(
            project: 'automation/ReleaseValidator/ReleaseValidator.xcodeproj',
            clean: true,
            device: "iPhone SE"
        )
        cleanReleaseProject
        resetSimulator
    end

    desc "Validate integrating the framework (for all xcode version specified in fastlane/versions-validate.json) into a sample project"
    lane :validateAll do
        versions = readXcodeVersionsValidation
        versions.each do |version|
            validateSDK(version: version)
        end
    end

    desc "Run System tests"
    lane :systemTests do 
        systemTestsAfterBuild(
    	    version: "10.0",
            project_directory: projectDirectory
    	)
    end
end
