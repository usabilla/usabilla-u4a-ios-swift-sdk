machine:
  xcode:
    version: 8.3.3
dependencies:
  pre: 
    - bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
    - gem update fastlane
  override:
    - bin/bootstrap-if-needed
  cache_directories:
    - "Carthage"
checkout:
  post:
    - git submodule update --init --recursive  
test:
    post:
    - bundle exec slather coverage --verbose
    - bundle exec slather coverage --html --output-directory $CIRCLE_ARTIFACTS/coverage
    - swift codecov.swift
    - bundle exec danger
    override:
      - set -o pipefail &&
        xcodebuild
          CODE_SIGNING_REQUIRED=NO
          CODE_SIGN_IDENTITY=
          PROVISIONING_PROFILE=
          -sdk iphonesimulator
          -destination 'platform=iOS Simulator,OS=9.0,name=iPhone 6'
          -workspace Usabilla.xcworkspace
          -scheme "Usabilla"
          test |
        tee $CIRCLE_ARTIFACTS/xcode_raw_ut.log |
        xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results_ut_ios_9_0_iPhone_6.xml

      - set -o pipefail &&
        xcodebuild
          CODE_SIGNING_REQUIRED=NO
          CODE_SIGN_IDENTITY=
          PROVISIONING_PROFILE=
          -sdk iphonesimulator
          -destination 'platform=iOS Simulator,OS=10.3.1,name=iPhone 7'
          -workspace Usabilla.xcworkspace
          -scheme "Usabilla"
          test |
        tee $CIRCLE_ARTIFACTS/xcode_raw_ut.log |
        xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results_ut_ios_10_3_iPhone_7.xml

      - set -o pipefail &&
        xcodebuild
          CODE_SIGNING_REQUIRED=NO
          CODE_SIGN_IDENTITY=
          PROVISIONING_PROFILE=
          -sdk iphonesimulator
          -destination 'platform=iOS Simulator,OS=9.0,name=iPhone 6'
          -workspace Usabilla.xcworkspace
          -scheme "UsabillaUITestApp"
          test |
        tee $CIRCLE_ARTIFACTS/xcode_raw_ui.log |
        xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results_ui.xml

      - if [ $CIRCLE_BRANCH = 'master' ]; then fastlane integrationTests; fi

